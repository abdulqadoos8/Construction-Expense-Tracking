<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Construction Expense Tracker</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- AOS Animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Reports Page Specific Styles */
        .report-card {
            background: white;
            border-radius: 24px;
            padding: 1.8rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            transition: all 0.3s;
            height: 100%;
            border: 1px solid rgba(67,97,238,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(67,97,238,0.1);
            border-color: var(--primary-color);
        }
        
        .report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s;
            transform-origin: left;
        }
        
        .report-card:hover::before {
            transform: scaleX(1);
        }
        
        .report-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            margin-bottom: 1.5rem;
            background: var(--gradient-primary);
            box-shadow: 0 10px 20px rgba(67,97,238,0.2);
        }
        
        .download-btn {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            text-decoration: none;
            width: 100%;
            justify-content: center;
            letter-spacing: 0.5px;
        }
        
        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,176,155,0.4);
            color: white;
        }
        
        .download-btn i {
            font-size: 1.2rem;
        }
        
        .stats-pill {
            background: #f8f9fa;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 1.5rem;
        }
        
        .summary-badge {
            background: white;
            border-radius: 16px;
            padding: 1.2rem;
            border: 1px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .summary-badge:hover {
            background: linear-gradient(135deg, #667eea10, #764ba210);
            border-color: #667eea;
        }
        
        .summary-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-color);
            line-height: 1;
            margin-bottom: 0.3rem;
        }
        
        .summary-label {
            color: #6c757d;
            font-weight: 500;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .trend-up {
            color: #00b09b;
            background: rgba(0,176,155,0.1);
            padding: 0.2rem 0.6rem;
            border-radius: 50px;
            font-size: 0.8rem;
        }
        
        .trend-down {
            color: #f83600;
            background: rgba(248,54,0,0.1);
            padding: 0.2rem 0.6rem;
            border-radius: 50px;
            font-size: 0.8rem;
        }
        
        .category-progress {
            height: 10px;
            border-radius: 5px;
            margin: 0.8rem 0;
            background-color: #e9ecef;
        }
        
        .progress-bar-custom {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 5px;
        }
        
        .table-report {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0,0,0,0.02);
        }
        
        .table-report thead th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
            padding: 1rem;
            border: none;
        }
        
        .period-selector {
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            display: inline-flex;
            border: 1px solid #e9ecef;
        }
        
        .period-btn {
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            border: none;
            background: transparent;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .period-btn.active {
            background: var(--gradient-primary);
            color: white;
        }
        
        .insight-card {
            background: linear-gradient(135deg, #667eea05, #764ba205);
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px dashed var(--primary-color);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar animate__animated animate__fadeInLeft">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <div class="bg-primary bg-gradient rounded-circle d-inline-flex p-3 mb-2 shadow-lg">
                            <i class="bi bi-building text-white" style="font-size: 2rem;"></i>
                        </div>
                        <h5 class="text-white mt-2 fw-bold">Construction Manager</h5>
                        <div class="text-white-50 small" id="userInfo">
                            <div class="spinner-border spinner-border-sm text-light" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/dashboard">
                                <i class="bi bi-speedometer2"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="/expenses">
                                <i class="bi bi-cash-stack"></i> Expenses
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active bg-primary text-white" href="/reports">
                                <i class="bi bi-bar-chart"></i> Reports
                            </a>
                        </li>
                        
                        <!-- Divider -->
                        <li class="nav-item mt-4">
                            <hr class="text-white-50">
                        </li>
                        
                        <!-- Quick Stats -->
                        <li class="nav-item px-3 mt-2">
                            <div class="text-white-50 small mb-2">
                                <i class="bi bi-graph-up"></i> REPORT PERIOD
                            </div>
                            <div class="bg-dark-50 rounded p-2">
                                <select class="form-select form-select-sm bg-dark text-white border-0" id="sidebarPeriod">
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">This Year</option>
                                    <option value="all">All Time</option>
                                </select>
                            </div>
                        </li>
                        
                        <!-- Divider -->
                        <li class="nav-item mt-4">
                            <hr class="text-white-50">
                        </li>
                        
                        <!-- Logout Button -->
                        <li class="nav-item mt-2">
                            <a class="nav-link text-white" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </a>
                        </li>
                    </ul>
                    
                    <!-- App Version -->
                    <div class="position-absolute bottom-0 start-0 p-3 w-100">
                        <div class="text-white-50 small">
                            <i class="bi bi-shield-check"></i> v2.0.0 | Analytics Pro
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div data-aos="fade-right">
                        <h1 class="h2 fw-bold text-primary">
                            <i class="bi bi-bar-chart"></i> Reports & Analytics
                        </h1>
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/dashboard" class="text-decoration-none">Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">Reports</li>
                            </ol>
                        </nav>
                    </div>
                    <div class="btn-toolbar mb-2 mb-md-0 gap-2" data-aos="fade-left">
                        <div class="period-selector">
                            <button class="period-btn" onclick="setPeriod(30)">30D</button>
                            <button class="period-btn" onclick="setPeriod(90)">90D</button>
                            <button class="period-btn active" onclick="setPeriod(365)">1Y</button>
                            <button class="period-btn" onclick="setPeriod(0)">All</button>
                        </div>
                        <button type="button" class="btn btn-outline-primary" onclick="refreshReports()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Key Metrics Row -->
                <div class="row mb-4" data-aos="fade-up" data-aos-delay="100">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="report-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="report-icon" style="background: linear-gradient(135deg, #4361ee, #3a0ca3);">
                                        <i class="bi bi-currency-rupee"></i>
                                    </div>
                                    <div class="summary-label">Total Expense</div>
                                    <div class="summary-value" id="totalExpenseMetric">Rs. 0</div>
                                </div>
                                <span class="trend-up" id="expenseTrend">
                                    <i class="bi bi-arrow-up"></i> 0%
                                </span>
                            </div>
                            <div class="mt-3">
                                <span class="stats-pill">
                                    <i class="bi bi-calendar"></i> Current Period
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="report-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="report-icon" style="background: linear-gradient(135deg, #00b09b, #96c93d);">
                                        <i class="bi bi-cash"></i>
                                    </div>
                                    <div class="summary-label">Total Paid</div>
                                    <div class="summary-value" id="totalPaidMetric">Rs. 0</div>
                                </div>
                                <span class="stats-pill">
                                    <i class="bi bi-check-circle"></i> <span id="paymentRatio">0%</span>
                                </span>
                            </div>
                            <div class="progress mt-3" style="height: 8px;">
                                <div class="progress-bar bg-success" id="paidProgressMetric" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="report-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="report-icon" style="background: linear-gradient(135deg, #f8961e, #f3722c);">
                                        <i class="bi bi-wallet2"></i>
                                    </div>
                                    <div class="summary-label">Remaining Balance</div>
                                    <div class="summary-value" id="remainingBalanceMetric">Rs. 0</div>
                                </div>
                                <span class="stats-pill">
                                    <i class="bi bi-clock-history"></i> <span id="pendingCount">0</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="report-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="report-icon" style="background: linear-gradient(135deg, #4a00e0, #8e2de2);">
                                        <i class="bi bi-box-seam"></i>
                                    </div>
                                    <div class="summary-label">Advance Payments</div>
                                    <div class="summary-value" id="advanceMetric">Rs. 0</div>
                                </div>
                                <span class="stats-pill">
                                    <i class="bi bi-arrow-up-circle"></i> <span id="advanceCount">0</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Download Reports Section -->
                <div class="row mb-4" data-aos="fade-up" data-aos-delay="200">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <i class="bi bi-download text-primary me-2 fs-5"></i>
                                    <span class="fw-bold fs-5">Download Reports</span>
                                </div>
                                <span class="badge bg-primary">Excel Format</span>
                            </div>
                            <div class="card-body">
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="insight-card h-100">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-primary bg-gradient rounded-3 p-3 me-3">
                                                    <i class="bi bi-file-earmark-spreadsheet fs-3 text-white"></i>
                                                </div>
                                                <div>
                                                    <h6 class="fw-bold mb-1">Complete Expense Report</h6>
                                                    <small class="text-muted">All transactions with details</small>
                                                </div>
                                            </div>
                                            <div class="d-grid">
                                                <a href="#" class="download-btn" onclick="downloadFullReport()">
                                                    <i class="bi bi-download"></i> Download Full Report
                                                </a>
                                            </div>
                                            <div class="mt-3 small text-muted">
                                                <i class="bi bi-info-circle"></i> Includes summary, materials, and all expenses
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="insight-card h-100">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-success bg-gradient rounded-3 p-3 me-3">
                                                    <i class="bi bi-box-seam fs-3 text-white"></i>
                                                </div>
                                                <div>
                                                    <h6 class="fw-bold mb-1">Material Summary Report</h6>
                                                    <small class="text-muted">Category-wise consumption</small>
                                                </div>
                                            </div>
                                            <div class="d-grid">
                                                <a href="#" class="download-btn" style="background: linear-gradient(135deg, #00b09b, #96c93d);" onclick="downloadMaterialReport()">
                                                    <i class="bi bi-download"></i> Download Material Summary
                                                </a>
                                            </div>
                                            <div class="mt-3 small text-muted">
                                                <i class="bi bi-info-circle"></i> Total quantities and costs by material
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="insight-card h-100">
                                            <div class="d-flex align-items-center mb-3">
                                                <div class="bg-warning bg-gradient rounded-3 p-3 me-3">
                                                    <i class="bi bi-currency-rupee fs-3 text-white"></i>
                                                </div>
                                                <div>
                                                    <h6 class="fw-bold mb-1">Advance Payment Report</h6>
                                                    <small class="text-muted">All advance transactions</small>
                                                </div>
                                            </div>
                                            <div class="d-grid">
                                                <a href="#" class="download-btn" style="background: linear-gradient(135deg, #f8961e, #f3722c);" onclick="downloadAdvanceReport()">
                                                    <i class="bi bi-download"></i> Download Advance Report
                                                </a>
                                            </div>
                                            <div class="mt-3 small text-muted">
                                                <i class="bi bi-info-circle"></i> Filtered advance payment entries
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4" data-aos="fade-up" data-aos-delay="300">
                    <div class="col-xl-6 mb-4">
                        <div class="report-card">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h5 class="fw-bold mb-1">
                                        <i class="bi bi-pie-chart text-primary me-2"></i>
                                        Category Distribution
                                    </h5>
                                    <small class="text-muted">Expense breakdown by category</small>
                                </div>
                                <span class="badge bg-light text-dark" id="categoryCount">0 categories</span>
                            </div>
                            <div class="chart-container">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-6 mb-4">
                        <div class="report-card">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h5 class="fw-bold mb-1">
                                        <i class="bi bi-bar-chart text-primary me-2"></i>
                                        Monthly Trend
                                    </h5>
                                    <small class="text-muted">Expense vs Payment trend</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="chartTypeToggle" checked>
                                    <label class="form-check-label small" for="chartTypeToggle">Show both</label>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Material Summary Table -->
                <div class="row mb-4" data-aos="fade-up" data-aos-delay="400">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <i class="bi bi-box-seam text-primary me-2 fs-5"></i>
                                    <span class="fw-bold fs-5">Material Consumption Summary</span>
                                </div>
                                <div>
                                    <span class="badge bg-primary me-2" id="totalMaterials">0 items</span>
                                    <span class="badge bg-success" id="totalQuantity">0 total</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-report">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Total Quantity</th>
                                                <th>Unit Type</th>
                                                <th>Entry Count</th>
                                                <th>Total Cost (PKR)</th>
                                                <th>Total Paid (PKR)</th>
                                                <th>Advance (PKR)</th>
                                                <th>% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="materialSummaryTableBody">
                                            <tr>
                                                <td colspan="8" class="text-center py-5">
                                                    <div class="spinner-border text-primary mb-3" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <div class="text-muted">Loading material summary...</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Summary Table -->
                <div class="row mb-4" data-aos="fade-up" data-aos-delay="500">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <i class="bi bi-calendar-month text-primary me-2 fs-5"></i>
                                    <span class="fw-bold fs-5">Monthly Expense Summary</span>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" onclick="exportMonthlyTable()">
                                    <i class="bi bi-download"></i> Export Table
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-report">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Total Expense (PKR)</th>
                                                <th>Total Paid (PKR)</th>
                                                <th>Advance (PKR)</th>
                                                <th>Entries</th>
                                                <th>Trend</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monthlySummaryTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner-border text-primary mb-3" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <div class="text-muted">Loading monthly summary...</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Category Summary Table -->
                <div class="row mb-4" data-aos="fade-up" data-aos-delay="600">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <i class="bi bi-tags text-primary me-2 fs-5"></i>
                                    <span class="fw-bold fs-5">Category-wise Expense Summary</span>
                                </div>
                                <span class="badge bg-info" id="categoryEntries">0 entries</span>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-report">
                                        <thead>
                                            <tr>
                                                <th>Category</th>
                                                <th>Total Expense (PKR)</th>
                                                <th>Total Paid (PKR)</th>
                                                <th>Remaining (PKR)</th>
                                                <th>Advance (PKR)</th>
                                                <th>Entry Count</th>
                                                <th>% of Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="categorySummaryTableBody">
                                            <tr>
                                                <td colspan="7" class="text-center py-5">
                                                    <div class="spinner-border text-primary mb-3" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <div class="text-muted">Loading category summary...</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Insights Section -->
                <div class="row mb-5" data-aos="fade-up" data-aos-delay="700">
                    <div class="col-12">
                        <div class="report-card bg-gradient" style="background: linear-gradient(135deg, #667eea10, #764ba210);">
                            <div class="d-flex align-items-center mb-4">
                                <div class="bg-primary bg-gradient rounded-3 p-3 me-3">
                                    <i class="bi bi-lightbulb fs-3 text-white"></i>
                                </div>
                                <div>
                                    <h5 class="fw-bold mb-1">Financial Insights</h5>
                                    <small class="text-muted">AI-powered analysis of your expenses</small>
                                </div>
                            </div>
                            <div class="row" id="insightsContainer">
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted">Payment Efficiency</small>
                                            <h6 class="mb-0 fw-bold" id="insightEfficiency">Loading...</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="bi bi-arrow-up-circle-fill text-primary fs-4"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted">Top Category</small>
                                            <h6 class="mb-0 fw-bold" id="insightTopCategory">Loading...</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="bi bi-box-seam-fill text-warning fs-4"></i>
                                        </div>
                                        <div>
                                            <small class="text-muted">Most Used Material</small>
                                            <h6 class="mb-0 fw-bold" id="insightTopMaterial">Loading...</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS Animation -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!-- Main Reports JS -->
    <script src="js/reports.js"></script>
    
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true,
            offset: 50
        });
        
        const API_BASE = 'http://localhost:3000/api';
        let categoryChart, monthlyChart;
        let currentPeriod = 365;
        
        async function logout() {
            const confirmLogout = confirm('Are you sure you want to logout?');
            if (!confirmLogout) return;
            
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    sessionStorage.clear();
                    localStorage.clear();
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }
        
        // Download Functions
        async function downloadFullReport() {
            try {
                window.location.href = `${API_BASE}/reports/expenses/excel`;
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading report');
            }
        }
        
        async function downloadMaterialReport() {
            try {
                window.location.href = `${API_BASE}/reports/materials/excel`;
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading material report');
            }
        }
        
        async function downloadAdvanceReport() {
            try {
                // This will be implemented in the backend
                alert('Advance report download will be available soon!');
            } catch (error) {
                console.error('Download error:', error);
            }
        }
        
        function setPeriod(days) {
            currentPeriod = days;
            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            refreshReports();
        }
        
        async function exportMonthlyTable() {
            // Create CSV from monthly table
            const table = document.getElementById('monthlySummaryTableBody');
            let csv = 'Month,Total Expense,Total Paid,Advance,Entries,Trend\n';
            
            table.querySelectorAll('tr').forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 1) {
                    const rowData = Array.from(cells).map(cell => cell.innerText.replace(/,/g, '')).join(',');
                    csv += rowData + '\n';
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monthly_summary_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success && result.data) {
                    const user = result.data;
                    document.getElementById('userInfo').innerHTML = `
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-person-circle me-1"></i>
                            <span>${user.name || user.username}</span>
                            <span class="badge bg-${user.role === 'super_admin' ? 'warning' : 'info'} ms-1 small">
                                ${user.role || 'admin'}
                            </span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
        });
    </script>
</body>
</html>